name: Build Python Packages

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-tags: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel twine

    - name: Build core package
      if: startsWith(github.ref, 'refs/tags/core-')
      run: pip wheel --no-deps -w wheels simpler-core/.

    - name: Build model package
      if: startsWith(github.ref, 'refs/tags/model-')
      run: pip wheel --no-deps -w wheels simpler-model/.

    - name: Check git describe for cli
      if: startsWith(github.ref, 'refs/tags/cli-')
      run: git describe --long --match cli-*
    - name: Build cli package
      if: startsWith(github.ref, 'refs/tags/cli-')
      run: pip wheel --no-deps -w wheels simpler-cli/.

    - name: Build api package
      if: startsWith(github.ref, 'refs/tags/api-')
      run: pip wheel --no-deps -w wheels simpler-core/.

    - name: Build plugin-rdf package
      if: startsWith(github.ref, 'refs/tags/plugin-rdf-')
      run: pip wheel --no-deps -w wheels simpler-plugin-rdf/.
      
    - name: Build plugin-sql package
      if: startsWith(github.ref, 'refs/tags/plugin-sql-')
      run: pip wheel --no-deps -w wheels simpler-plugin-sql/.
    
    - name: Build plugin-tabular package
      if: startsWith(github.ref, 'refs/tags/plugin-tabular-')
      run: pip wheel --no-deps -w wheels simpler-plugin-tabular/.

    - name: Build plugin-xml package
      if: startsWith(github.ref, 'refs/tags/plugin-xml-')
      run: pip wheel --no-deps -w wheels simpler-plugin-xml/.

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wheels
        path: wheels/

#    - name: Publish package
#      env:
#        TWINE_USERNAME: __token__
#        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
#      run: twine upload dist/*